#!/bin/sh
#
# Epsilon command-line interface
#
# Works from fresh checkout or system installation.
# Uses bundled SBCL if available, otherwise system SBCL.
#

set -eu

# The user's working directory
export EPSILON_USER="$PWD"

# Resolve symlinks to find the actual epsilon installation
SCRIPT="$0"
while [ -L "$SCRIPT" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT")" && pwd)"
    SCRIPT="$(readlink "$SCRIPT")"
    # Handle relative symlinks
    case "$SCRIPT" in
        /*) ;;
        *) SCRIPT="$SCRIPT_DIR/$SCRIPT" ;;
    esac
done

# The directory where epsilon is located
export EPSILON_HOME="$(cd "$(dirname "$SCRIPT")" && pwd)"
EPSILON_BOOT="$EPSILON_HOME/modules/core/src/epsilon.lisp"

# Detect boot script
if ! [ -f "$EPSILON_BOOT" ]; then
    echo "Error: epsilon boot script not found in $EPSILON_HOME" >&2
    exit 1
fi

# Find SBCL: prefer bundled, fall back to system
SBCL=""
SBCL_CORE_ARG=""

if [ -x "$EPSILON_HOME/bin/sbcl" ]; then
    # Use bundled SBCL
    SBCL="$EPSILON_HOME/bin/sbcl"
    if [ -f "$EPSILON_HOME/lib/sbcl-libs/sbcl.core" ]; then
        export SBCL_HOME="$EPSILON_HOME/lib/sbcl-libs"
        SBCL_CORE_ARG="--core $SBCL_HOME/sbcl.core"
    fi
elif command -v sbcl >/dev/null 2>&1; then
    # Use system SBCL
    SBCL="sbcl"
else
    echo "Error: SBCL not found" >&2
    echo "Please install SBCL: https://www.sbcl.org/" >&2
    exit 1
fi

# Parse debug, rebuild, and quiet flags before passing to SBCL
DEBUG_MODE="false"
REBUILD_BOOT="false"
QUIET_MODE="false"

# Check for our custom flags
while [ $# -gt 0 ]; do
    case "$1" in
        --debug)
            DEBUG_MODE="true"
            shift
            ;;
        --rebuild)
            REBUILD_BOOT="true"
            shift
            ;;
        --quiet)
            QUIET_MODE="true"
            shift
            ;;
        *)
            break  # Stop at first non-epsilon flag
            ;;
    esac
done
# Now $@ contains only the remaining arguments

# Force rebuild of bootstrap.fasl if requested
if [ "$REBUILD_BOOT" = "true" ]; then
    echo "Forcing rebuild of bootstrap cache..."
    rm -f "$EPSILON_HOME/modules/core/target/bootstrap.fasl"
fi

SBCL_RUNTIME_ARGS="--noinform"
if [ "$DEBUG_MODE" = "true" ]; then
    SBCL_TOPLEVEL_ARGS="--no-sysinit --no-userinit --quit"
else
    SBCL_TOPLEVEL_ARGS="--no-sysinit --no-userinit --disable-debugger --quit"
fi

cd "$EPSILON_HOME"

# Pass --quiet flag back to the Lisp side if quiet mode is enabled
if [ "$QUIET_MODE" = "true" ]; then
    if [ $# -eq 0 ]; then
        set -- "--quiet"
    else
        set -- "--quiet" "$@"
    fi
fi

# Note: SBCL args must be unquoted, user args must be quoted
if [ $# -eq 0 ]; then
    exec "$SBCL" $SBCL_CORE_ARG $SBCL_RUNTIME_ARGS \
         $SBCL_TOPLEVEL_ARGS \
         --load "$EPSILON_BOOT" \
         --eval "(epsilon.main:cli-run)" \
         --
else
    exec "$SBCL" $SBCL_CORE_ARG $SBCL_RUNTIME_ARGS \
         $SBCL_TOPLEVEL_ARGS \
         --load "$EPSILON_BOOT" \
         --eval "(epsilon.main:cli-run)" \
         -- "$@"
fi
