name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        # windows-latest temporarily disabled until local testing machine available

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SBCL (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y sbcl

    - name: Install SBCL (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install sbcl

    - name: Install SBCL (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install sbcl

    - name: Run tests
      run: |
        ./run.sh test epsilon.core

    - name: Test runtime build (Unix)
      if: runner.os != 'Windows'
      run: |
        chmod +x scripts/build-runtime.sh
        ./scripts/build-runtime.sh
        
        # Test the built runtime
        mkdir -p test-runtime
        cd test-runtime
        tar -xzf ../target/epsilon-*.tar.gz
        ./epsilon --eval "(format t \"~%CI test successful!~%\")" --eval "(sb-ext:quit)"

    - name: Test runtime build (Windows)
      if: runner.os == 'Windows'
      run: |
        scripts/build-runtime.sh
        
        # Test the built runtime
        mkdir test-runtime
        cd test-runtime
        unzip ../target/epsilon-*.zip
        ./epsilon.exe --eval "(format t \"~%CI test successful!~%\")" --eval "(sb-ext:quit)"